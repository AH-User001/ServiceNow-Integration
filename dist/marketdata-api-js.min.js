/*! marketdata-api-js - v1.0.0 - 2015-03-05
* https://github.com/barchart/marketdata-api-js
* Copyright (c) 2015 ; Licensed  */
var BarchartFormatter=function(a,b){var c=function(a,b){return["000",Math.floor(a)].join("").substr(-1*b)},d=void 0;d="."==a?function(a,b){if(!a)return"";switch(b){case"2":return a.toFixed(3);case"3":return a.toFixed(4);case"4":return a.toFixed(5);case"5":return a.toFixed(6);case"6":return a.toFixed(7);case"7":return a.toFixed(8);case"8":return a.toFixed(0);case"9":return a.toFixed(1);case"A":return a.toFixed(2);case"B":return a.toFixed(3);case"C":return a.toFixed(4);case"D":return a.toFixed(5);case"E":return a.toFixed(6);default:return a}}:function(d,e){if(!d)return"";var f=d>=0?"":"-";switch(d=Math.abs(d),e){case"2":return[f,Math.floor(d),a,c(8*(d-Math.floor(d)),1)].join("");case"3":return[f,Math.floor(d),a,c(16*(d-Math.floor(d)),2)].join("");case"4":return[f,Math.floor(d),a,c(32*(d-Math.floor(d)),2)].join("");case"5":return[f,Math.floor(d),a,c((d-Math.floor(d))*(b?320:64),b?3:2)].join("");case"6":return[f,Math.floor(d),a,c((d-Math.floor(d))*(b?320:128),3)].join("");case"7":return[f,Math.floor(d),a,c((d-Math.floor(d))*(b?320:256),3)].join("");case"8":return f+d.toFixed(0);case"9":return f+d.toFixed(1);case"A":return f+d.toFixed(2);case"B":return f+d.toFixed(3);case"C":return f+d.toFixed(4);case"D":return f+d.toFixed(5);case"E":return f+d.toFixed(6);default:return f+d}};var e=function(a){return[["00",a.getHours()].join("").substr(-2),["00",a.getMinutes()].join("").substr(-2),["00",a.getSeconds()].join("").substr(-2),["000",a.getMilliseconds()].join("").substr(-3)].join(":")};return{formatPrice:d,formatTime:e}},BarchartUtil={MonthCodes:{F:"January",G:"February",H:"March",J:"April",K:"May",M:"June",N:"July",Q:"August",U:"September",V:"October",X:"November",Z:"December"},BaseCode2UnitCode:function(a){switch(a){case-1:return"2";case-2:return"3";case-3:return"4";case-4:return"5";case-5:return"6";case-6:return"7";case 0:return"8";case 1:return"9";case 2:return"A";case 3:return"B";case 4:return"C";case 5:return"D";case 6:return"E";case 7:return"F";default:return 0}},DayCodeToNumber:function(a){var b=a.charCodeAt(0);return b>="1".charCodeAt(0)&&a<="9".charCodeAt(0)?b-"0".charCodeAt(0):a=="0".charCodeAt(0)?10:b-"A".charCodeAt(0)+11},DateToDayCode:function(a){var b=a.getDate();return b>=1&&9>=b?String.fromCharCode("1".charCodeAt(0)+b-1):10==b?"0":String.fromCharCode("A".charCodeAt(0)+b-11)},ParseSymbolType:function(a){var b=/[0-9]$/;if(b.test(a)){var c=/^(.{1,3})([A-Z])([0-9]{1,4})$/i,d=c.exec(a),e=parseInt(d[3]);return 10>e?e+=2010:100>e&&(e+=2e3),{type:"future",symbol:d[0],root:d[1],month:d[2],year:e}}return null},UnitCode2BaseCode:function(a){switch(a){case"2":return-1;case"3":return-2;case"4":return-3;case"5":return-4;case"6":return-5;case"7":return-6;case"8":return 0;case"9":return 1;case"A":return 2;case"B":return 3;case"C":return 4;case"D":return 5;case"E":return 6;case"F":return 7;default:return 0}}},BarchartMessageParser={ParseTimestamp:function(a){if(9!=a.length)return null;var b=100*a.charCodeAt(0)+a.charCodeAt(1)-64,c=a.charCodeAt(2)-64-1,d=a.charCodeAt(3)-64,e=a.charCodeAt(4)-64,f=a.charCodeAt(5)-64,g=a.charCodeAt(6)-64,h=(255&a.charCodeAt(7))+((255&a.charCodeAt(8))<<8);return new Date(b,c,d,e,f,g,h)},ParseValue:function(a,b){if(a.length<1)return void 0;if("-"==a)return null;if(a.indexOf(".")>0)return parseFloat(a);switch(b){case"2":return parseInt(a.substr(0,a.length-1))+parseInt(a.substr(-1))/8;case"3":return parseInt(a.substr(0,a.length-2))+parseInt(a.substr(-2))/16;case"4":return parseInt(a.substr(0,a.length-2))+parseInt(a.substr(-2))/32;case"5":return parseInt(a.substr(0,a.length-2))+parseInt(a.substr(-2))/64;case"6":return parseInt(a.substr(0,a.length-3))+parseInt(a.substr(-3))/128;case"7":return parseInt(a.substr(0,a.length-4))+parseInt(a.substr(-3))/256;case"8":return parseInt(a);case"9":return parseInt(a)/10;case"A":return parseInt(a)/100;case"B":return parseInt(a)/1e3;case"C":return parseInt(a)/1e4;case"D":return parseInt(a)/1e5;case"E":return parseInt(a)/1e6;default:return parseInt(a)}},Parse:function(a){var b={message:a,type:null};switch(a.substr(0,1)){case"%":try{if(window.DOMParser){var c=new DOMParser;xml=c.parseFromString(a.substring(1),"text/xml")}else xml=new ActiveXObject("Microsoft.XMLDOM"),xml.async="false",xml.loadXML(a.substring(1))}catch(d){xml=void 0}if(xml){var e=xml.firstChild;switch(e.nodeName){case"BOOK":b.symbol=e.attributes.getNamedItem("symbol").value,b.unitcode=e.attributes.getNamedItem("basecode").value,b.askDepth=parseInt(e.attributes.getNamedItem("bidcount").value),b.bidDepth=parseInt(e.attributes.getNamedItem("bidcount").value),b.asks=[],b.bids=[];var f,g;if(e.attributes.getNamedItem("askprices")&&e.attributes.getNamedItem("asksizes")){f=e.attributes.getNamedItem("askprices").value.split(","),g=e.attributes.getNamedItem("asksizes").value.split(",");for(var h=0;h<f.length;h++)b.asks.push({price:BarchartMessageParser.ParseValue(f[h],b.unitcode),size:parseInt(g[h])})}if(e.attributes.getNamedItem("bidprices")&&e.attributes.getNamedItem("bidsizes")){f=e.attributes.getNamedItem("bidprices").value.split(","),g=e.attributes.getNamedItem("bidsizes").value.split(",");for(var h=0;h<f.length;h++)b.bids.push({price:BarchartMessageParser.ParseValue(f[h],b.unitcode),size:parseInt(g[h])})}b.type="BOOK";break;case"QUOTE":for(var h=0;h<e.attributes.length;h++){switch(e.attributes[h].name){case"symbol":b.symbol=e.attributes[h].value;break;case"name":b.name=e.attributes[h].value;break;case"exchange":b.exchange=e.attributes[h].value;break;case"basecode":b.unitcode=e.attributes[h].value;break;case"pointvalue":b.pointValue=parseFloat(e.attributes[h].value);break;case"tickincrement":b.tickIncrement=parseInt(e.attributes[h].value);break;case"flag":b.flag=e.attributes[h].value;break;case"lastupdate":var i=e.attributes[h].value;b.lastUpdate=new Date(parseInt(i.substr(0,4)),parseInt(i.substr(4,2))-1,parseInt(i.substr(6,2)),parseInt(i.substr(8,2)),parseInt(i.substr(10,2)),parseInt(i.substr(12,2)));break;case"bid":b.bidPrice=BarchartMessageParser.ParseValue(e.attributes[h].value,b.unitcode);break;case"bidsize":b.bidSize=parseInt(e.attributes[h].value);break;case"ask":b.askPrice=BarchartMessageParser.ParseValue(e.attributes[h].value,b.unitcode);break;case"asksize":b.askSize=parseInt(e.attributes[h].value);break;case"mode":b.mode=e.attributes[h].value}for(var j={},k=0;k<e.childNodes.length;k++)if("SESSION"==e.childNodes[k].nodeName){var l={},m=e.childNodes[k].attributes;if(m.getNamedItem("id")&&(l.id=m.getNamedItem("id").value),m.getNamedItem("day")&&(l.day=m.getNamedItem("day").value),m.getNamedItem("last")&&(l.lastPrice=BarchartMessageParser.ParseValue(m.getNamedItem("last").value,b.unitcode)),m.getNamedItem("previous")&&(l.previousPrice=BarchartMessageParser.ParseValue(m.getNamedItem("previous").value,b.unitcode)),m.getNamedItem("open")&&(l.openPrice=BarchartMessageParser.ParseValue(m.getNamedItem("open").value,b.unitcode)),m.getNamedItem("high")&&(l.highPrice=BarchartMessageParser.ParseValue(m.getNamedItem("high").value,b.unitcode)),m.getNamedItem("low")&&(l.lowPrice=BarchartMessageParser.ParseValue(m.getNamedItem("low").value,b.unitcode)),m.getNamedItem("tradesize")&&(l.tradeSize=parseInt(m.getNamedItem("tradesize").value)),m.getNamedItem("numtrades")&&(l.numberOfTrades=parseInt(m.getNamedItem("numtrades").value)),m.getNamedItem("settlement")&&(l.settlementPrice=BarchartMessageParser.ParseValue(m.getNamedItem("settlement").value,b.unitcode)),m.getNamedItem("volume")&&(l.volume=parseInt(m.getNamedItem("volume").value)),m.getNamedItem("openinterest")&&(l.openInterest=parseInt(m.getNamedItem("openinterest").value)),m.getNamedItem("timestamp")){var i=m.getNamedItem("timestamp").value;l.timeStamp=new Date(parseInt(i.substr(0,4)),parseInt(i.substr(4,2))-1,parseInt(i.substr(6,2)),parseInt(i.substr(8,2)),parseInt(i.substr(10,2)),parseInt(i.substr(12,2)))}if(m.getNamedItem("tradetime")){var i=m.getNamedItem("tradetime").value;l.tradeTime=new Date(parseInt(i.substr(0,4)),parseInt(i.substr(4,2))-1,parseInt(i.substr(6,2)),parseInt(i.substr(8,2)),parseInt(i.substr(10,2)),parseInt(i.substr(12,2)))}l.id&&(j[l.id]=l)}var l=j.combined.lastPrice?j.combined:j.previous;l.lastPrice&&(b.lastPrice=l.lastPrice),l.previousPrice&&(b.previousPrice=l.previousPrice),l.openPrice&&(b.openPrice=l.openPrice),l.highPrice&&(b.highPrice=l.highPrice),l.lowPrice&&(b.lowPrice=l.lowPrice),l.tradeSize&&(b.tradeSize=l.tradeSize),l.numberOfTrades&&(b.numberOfTrades=l.numberOfTrades),l.settlementPrice&&(b.settlementPrice=l.settlementPrice),l.volume&&(b.volume=l.volume),l.openInterest&&(b.openInterest=l.openInterest),l.timeStamp&&(b.timeStamp=l.timeStamp),l.tradeTime&&(b.tradeTime=l.tradeTime),"combined"==l.id&&j.previous.openInterest&&(b.openInterest=j.previous.openInterest)}j.combined.day&&(b.day=j.combined.day),b.type="REFRESH_QUOTE";break;default:console.log(a)}}break;case"":switch(a.substr(1,1)){case"#":b.type="TIMESTAMP",b.timestamp=new Date(parseInt(a.substr(2,4)),parseInt(a.substr(6,2))-1,parseInt(a.substr(8,2)),parseInt(a.substr(10,2)),parseInt(a.substr(12,2)),parseInt(a.substr(14,2)));break;case"2":b.record="2";var n=a.indexOf(",",0);switch(b.symbol=a.substring(2,n),b.subrecord=a.substr(n+1,1),b.unitcode=a.substr(n+3,1),b.exchange=a.substr(n+4,1),b.delay=parseInt(a.substr(n+5,2)),b.subrecord){case"0":var o=a.indexOf(",",n+7);switch(b.value=BarchartMessageParser.ParseValue(a.substring(n+7,o),b.unitcode),b.element=a.substr(o+1,1),b.modifier=a.substr(o+2,1),b.element){case"A":b.type="OPEN";break;case"C":"1"==b.modifier&&(b.type="OPEN_INTEREST");break;case"D":case"d":"0"==b.modifier&&(b.type="SETTLEMENT");break;case"V":"0"==b.modifier&&(b.type="VWAP");break;case"0":"0"==b.modifier&&(b.tradePrice=b.value,b.type="TRADE");break;case"5":b.type="HIGH";break;case"6":b.type="LOW";break;case"7":"1"==b.modifier?b.type="VOLUME_YESTERDAY":"6"==b.modifier&&(b.type="VOLUME")}b.day=a.substr(o+3,1),b.session=a.substr(o+4,1),b.time=BarchartMessageParser.ParseTimestamp(a.substr(a.indexOf("")+1,9));break;case"1":case"2":case"3":case"4":var p=a.substring(n+8).split(",");b.openPrice=BarchartMessageParser.ParseValue(p[0],b.unitcode),b.highPrice=BarchartMessageParser.ParseValue(p[1],b.unitcode),b.lowPrice=BarchartMessageParser.ParseValue(p[2],b.unitcode),b.lastPrice=BarchartMessageParser.ParseValue(p[3],b.unitcode),b.bidPrice=BarchartMessageParser.ParseValue(p[4],b.unitcode),b.askPrice=BarchartMessageParser.ParseValue(p[5],b.unitcode),b.previousPrice=BarchartMessageParser.ParseValue(p[7],b.unitcode),b.settlementPrice=BarchartMessageParser.ParseValue(p[10],b.unitcode),b.volume=p[13].length>0?parseInt(p[13]):void 0,b.openInterest=p[12].length>0?parseInt(p[12]):void 0,b.day=p[14].substr(0,1),b.session=p[14].substr(1,1),b.time=BarchartMessageParser.ParseTimestamp(a.substr(a.indexOf("")+1,9)),b.type="REFRESH_DDF";break;case"7":var o=a.indexOf(",",n+7);b.tradePrice=BarchartMessageParser.ParseValue(a.substring(n+7,o),b.unitcode),n=o+1,o=a.indexOf(",",n),b.tradeSize=parseInt(a.substring(n,o)),n=o+1,b.day=a.substr(n,1),b.session=a.substr(n+1,1),b.time=BarchartMessageParser.ParseTimestamp(a.substr(a.indexOf("")+1,9)),b.type="TRADE";break;case"8":var o=a.indexOf(",",n+7);b.bidPrice=BarchartMessageParser.ParseValue(a.substring(n+7,o),b.unitcode),n=o+1,o=a.indexOf(",",n),b.bidSize=parseInt(a.substring(n,o)),n=o+1,o=a.indexOf(",",n),b.askPrice=BarchartMessageParser.ParseValue(a.substring(n,o),b.unitcode),n=o+1,o=a.indexOf(",",n),b.askSize=parseInt(a.substring(n,o)),n=o+1,b.day=a.substr(n,1),b.session=a.substr(n+1,1),b.time=BarchartMessageParser.ParseTimestamp(a.substr(a.indexOf("")+1,9)),b.type="TOB";break;case"Z":var o=a.indexOf(",",n+7);b.tradePrice=BarchartMessageParser.ParseValue(a.substring(n+7,o),b.unitcode),n=o+1,o=a.indexOf(",",n),b.tradeSize=parseInt(a.substring(n,o)),n=o+1,b.day=a.substr(n,1),b.session=a.substr(n+1,1),b.time=BarchartMessageParser.ParseTimestamp(a.substr(a.indexOf("")+1,9)),b.type="TRADE_OUT_OF_SEQUENCE"}break;case"3":var n=a.indexOf(",",0);switch(b.symbol=a.substring(2,n),b.subrecord=a.substr(n+1,1),b.subrecord){case"B":b.unitcode=a.substr(n+3,1),b.exchange=a.substr(n+4,1),b.bidDepth="A"==a.substr(n+5,1)?10:parseInt(a.substr(n+5,1)),b.askDepth="A"==a.substr(n+6,1)?10:parseInt(a.substr(n+6,1)),b.bids=[],b.asks=[];for(var p=a.substring(n+8).split(","),h=0;h<p.length;h++){var g=p[h].split(/[A-Z]/),q=p[h].substr(g[0].length,1);"J">=q?b.asks.push({price:BarchartMessageParser.ParseValue(g[0],b.unitcode),size:parseInt(g[1])}):b.bids.push({price:BarchartMessageParser.ParseValue(g[0],b.unitcode),size:parseInt(g[1])})}b.type="BOOK"}break;default:b.type="UNKNOWN"}}return b}},BarchartMarketState=function(){var a={},b={},c={},d={},e=void 0,f=function(b){return a[b]||(a[b]={symbol:b,bids:[],asks:[]}),a[b]},g=function(a){return c[a]||(c[a]={symbol:a,name:void 0,root:void 0,month:void 0,year:void 0,exchange:void 0,unitCode:void 0,pointValue:void 0,tickIncrement:void 0}),c[a]},h=function(a){return d[a]||(d[a]={symbol:a,message:null,flag:void 0,mode:void 0,day:void 0,dayNum:0,session:void 0,lastUpdate:void 0,bidPrice:void 0,bidSize:void 0,askPrice:void 0,askSize:void 0,lastPrice:void 0,tradePrice:void 0,tradeSize:void 0,numberOfTrades:void 0,vwap1:void 0,vwap2:void 0,settlementPrice:void 0,openPrice:void 0,highPrice:void 0,lowPrice:void 0,volume:void 0,openInterest:void 0,previousPrice:void 0,time:void 0,ticks:[]}),d[a]},i=function(a){var b=h(a.symbol),c=g(a.symbol);if(!b.day&&a.day&&(b.day=a.day,b.dayNum=BarchartUtil.DayCodeToNumber(b.day)),"BOOK"!=a.type&&b.day&&a.day){var d=BarchartUtil.DayCodeToNumber(a.day);(d>b.dayNum||b.dayNum-d>5)&&(b.day=a.day,b.dayNum=d,b.flag="p",b.bidPrice=0,b.bidSize=void 0,b.askPrice=void 0,b.askSize=void 0,b.settlementPrice?b.previousPrice=b.settlementPrice:b.lastPrice&&(b.previousPrice=b.lastPrice),b.lastPrice=void 0,b.tradePrice=void 0,b.tradeSize=void 0,b.numberOfTrades=void 0,b.openPrice=void 0,b.highPrice=void 0,b.lowPrice=void 0,b.volume=void 0)}switch(a.type){case"BOOK":var i=f(a.symbol);i.asks=a.asks,i.bids=a.bids;break;case"HIGH":b.highPrice=a.value;break;case"LOW":b.lowPrice=a.value;break;case"OPEN":b.flag=void 0,b.openPrice=a.value,b.highPrice=a.value,b.lowPrice=a.value,b.lastPrice=a.value;break;case"OPEN_INTEREST":b.openInterest=a.value;break;case"REFRESH_DDF":switch(a.subrecord){case"1":case"2":case"3":b.message=a,null===a.openPrice?b.openPrice=void 0:a.openPrice&&(b.openPrice=a.openPrice),null===a.highPrice?b.highPrice=void 0:a.highPrice&&(b.highPrice=a.highPrice),null===a.lowPrice?b.lowPrice=void 0:a.lowPrice&&(b.lowPrice=a.lowPrice),null===a.lastPrice?b.lastPrice=void 0:a.lastPrice&&(b.lastPrice=a.lastPrice),null===a.bidPrice?b.bidPrice=void 0:a.bidPrice&&(b.bidPrice=a.bidPrice),null===a.askPrice?b.askPrice=void 0:a.askPrice&&(b.askPrice=a.askPrice),null===a.previousPrice?b.previousPrice=void 0:a.previousPrice&&(b.previousPrice=a.previousPrice),null===a.settlementPrice?(b.settlementPrice=void 0,"s"==b.flag&&(b.flag=void 0)):a.settlementPrice?b.settlementPrice=a.settlementPrice:(b.settlementPrice=void 0,"s"==b.flag&&(b.flag=void 0)),null===a.volume?b.volume=void 0:a.volume&&(b.volume=a.volume),null===a.openInterest?b.openInterest=void 0:a.openInterest&&(b.openInterest=a.openInterest),"1"==a.subsrecord&&(b.lastUpdate=a.time)}break;case"REFRESH_QUOTE":c.name=a.name,c.exchange=a.exchange,c.unitCode=a.unitcode,c.pointValue=a.pointValue,c.tickIncrement=a.tickIncrement;var j=BarchartUtil.ParseSymbolType(c.symbol);j&&"future"==j.type&&(c.root=j.root,c.month=j.month,c.year=j.year),b.message=a,b.flag=a.flag,b.mode=a.mode,b.lastUpdate=a.lastUpdate,b.bidPrice=a.bidPrice,b.bidSize=a.bidSize,b.askPrice=a.askPrice,b.askSize=a.askSize,b.lastPrice=a.lastPrice,b.tradeSize=a.tradeSize,b.numberOfTrades=a.numberOfTrades,b.previousPrice=a.previousPrice,b.settlementPrice=a.settlementPrice,b.openPrice=a.openPrice,b.highPrice=a.highPrice,b.lowPrice=a.lowPrice,b.volume=a.volume,b.openInterest=a.openInterest,a.tradeTime?b.time=a.tradeTime:a.timeStamp&&(b.time=a.timeStamp);break;case"SETTLEMENT":b.lastPrice=a.value,b.settlement=a.value,"D"==a.element&&(b.flag="s");case"TIMESTAMP":e=a.timestamp;break;case"TOB":b.bidPrice=a.bidPrice,b.bidSize=a.bidSize,b.askPrice=a.askPrice,b.askSize=a.askSize,a.time&&(b.time=a.time);break;case"TRADE":for(b.tradePrice=a.tradePrice,b.lastPrice=a.tradePrice,a.tradeSize&&(b.tradeSize=a.tradeSize,b.volume+=a.tradeSize),b.ticks.push({price:b.tradePrice,size:b.tradeSize});b.ticks.length>50;)b.ticks.shift();b.numberOfTrades||(b.numberOfTrades=0),b.numberOfTrades++,a.time&&(b.time=a.time),b.flag=void 0;break;case"TRADE_OUT_OF_SEQUENCE":b.volume+=a.tradeSize;break;case"VOLUME":b.volume=a.value;break;case"VOLUME_YESTERDAY":break;case"VWAP":b.vwap1=a.value;break;default:console.error("Unhandled Market Message:"),console.log(a)}};return{getBook:function(b){return a[b]},getCVol:function(a){return b[a]},getProfile:function(a){return c[a]},getQuote:function(a){return d[a]},getTimestamp:function(){return e},processMessage:i}},BarchartRealtimeData=function(){_API_VERSION=4;var a=new BarchartProfiles,b="DISCONNECTED",c={},d={symbols:[],symbols_off:[]},e=[],f=null,g=[],h=new BarchartMarketState,i=[],j={disconnect:[],marketDepth:{},marketUpdate:{},timestamp:[]},k={username:null,password:null,server:null},l=function(a,b){var c;switch(a){case"disconnect":c=j.disconnect;break;case"marketDepth":c=j.marketDepth[b.symbol];break;case"marketUpdate":c=j.marketUpdate[b.symbol];break;case"timestamp":c=j.timestamp}if(c)for(var d=0;d<c.length;d++)c[d](b)},m=function(){for(var a=e.shift();a;)f.send(a),a=e.shift();setTimeout(m,200)},n=function(a){var b;try{if(b=BarchartMessageParser.Parse(a),b.type)switch(h.processMessage(b),b.type){case"BOOK":l("marketDepth",b);break;case"TIMESTAMP":l("timestamp",h.getTimestamp());break;default:l("marketUpdate",b)}else console.log(a)}catch(c){console.error(c),console.log(b),console.trace()}},o=function(){for(var a=!1,b=9;!a;){var c=g.shift();if(c){var d=!1,e=1,f=-1,h=c.indexOf(""),i=c.indexOf("\n");if(i>-1&&(0>h||h>i)?(f=i,e=2):h>-1&&(f=h),f>-1){var j=f+1;if(1==e&&(c.length<f+b+1?(g.length>0?g[0]=c+g[0]:(g.unshift(c),a=!0),d=!0):""==c.substr(f+1,1)&&(j+=b+1)),!d){var k=c.substring(0,j);2==e?k=k.trim():(f=k.indexOf(""),f>0&&(k=k.substring(f))),k.length>0&&n(k),c=c.substring(j),c.length>0&&(g.length>0?g[0]=c+g[0]:g.unshift(c))}}else c.length>0&&(g.length>0?g[0]=c+g[0]:(g.unshift(c),a=!0))}else a=!0;0==g.length&&(a=!0)}setTimeout(o,125)},p=function(a){if("DISCONNECTED"==b&&(b="CONNECTING"),"CONNECTING"==b)for(var c=a.split("\n"),d=0;d<c.length;d++)if("+++"==c[d])return b="LOGGING_IN",void e.push("LOGIN "+k.username+":"+k.password+" VERSION="+_API_VERSION+"\r\n");"LOGGING_IN"==b&&"+"==a.substr(0,1)&&(b="LOGGED_IN"),"LOGGED_IN"==b&&g.push(a)},q=function(){for(var a=i.shift();a;)a&&p(a),a=i.shift();setTimeout(q,125)},r=function(){if("LOGGED_IN"==b){if(d.symbols.length>0){var a=d.symbols;d.symbols=[];for(var c="GO ",f=0;f<a.length;f++)f>0&&(c+=","),c+=a[f]+"=SsBbV";e.push(c)}if(d.symbols_off.length>0){var a=d.symbols_off;d.symbols_off=[];for(var c="STOP ",f=0;f<a.length;f++)f>0&&(c+=","),c+=a[f];e.push(c)}}setTimeout(r,200)},s=function(){var a=[];for(var b in c)a.push(b);$.ajax({url:"quotes.php?username="+k.username+"&password="+k.password+"&symbols="+a.join(",")}).done(function(a){$(a).find("QUOTE").each(function(){n("%"+this.outerHTML)})}),setTimeout(s,5e3)},t=function(a,e,g){f||(k.username=e,k.password=g,k.server=a,window.WebSocket?(f=new WebSocket("wss://"+k.server+"/jerq"),f.onclose=function(){b="DISCONNECTED",console.warn(new Date+" connection closed."),l("disconnect"),setTimeout(function(){if(f=null,t(k.server,k.username,k.password),0==d.symbols.length)for(var a in c)d.symbols.push(a)},5e3)},f.onmessage=function(a){i.push(a.data)},f.onopen=function(){console.log(new Date+" connection open.")}):(console.warn("Websockets are not supported by this browser. Invoking refreshing quotes."),setTimeout(s,1e3)))},u=function(){b="DISCONNECTED",null!=f&&(f.send("LOGOUT\r\n"),f.close(),f=null),b="DISCONNECTED",e=[],__messages=[],c={}},v=function(){if(arguments.length<2)throw new Error("Bad number of arguments. Must pass in an evnetId and handler.");var a=arguments[0],b=arguments[1];switch(a){case"disconnect":for(var c=0;c<j.disconnect.length;c++)j.disconnect[c]==b&&j.disconnect.splice(c,1);break;case"marketDepth":if(arguments.length<3)throw new Error("Bad number of arguments. For marketUpdate events, please specify a symbol. on('marketUpdate', handler, symbol).");var d=arguments[2];if(!j.marketDepth[d])return;for(var c=0;c<j.marketDepth[d].length;c++)j.marketDepth[d][c]==b&&j.marketDepth[d].splice(c,1);break;case"marketUpdate":if(arguments.length<3)throw new Error("Bad number of arguments. For marketUpdate events, please specify a symbol. on('marketUpdate', handler, symbol).");var d=arguments[2];if(!j.marketUpdate[d])return;for(var c=0;c<j.marketUpdate[d].length;c++)j.marketUpdate[d][c]==b&&j.marketUpdate[d].splice(c,1)}},w=function(){if(arguments.length<2)throw new Error("Bad number of arguments. Must pass in an evnetId and handler.");var a=arguments[0],b=arguments[1];switch(a){case"disconnect":for(var c=!0,d=0;d<j.disconnect.length;d++)j.disconnect[d]==b&&(c=!1);c&&j.disconnect.push(b);break;case"marketDepth":if(arguments.length<3)throw new Error("Bad number of arguments. For marketUpdate events, please specify a symbol. on('marketUpdate', handler, symbol).");var e=arguments[2];j.marketDepth[e]||(j.marketDepth[e]=[]);for(var c=!0,d=0;d<j.marketDepth[e].length;d++)j.marketDepth[e][d]==b&&(c=!1);c&&j.marketDepth[e].push(b);break;case"marketUpdate":if(arguments.length<3)throw new Error("Bad number of arguments. For marketUpdate events, please specify a symbol. on('marketUpdate', handler, symbol).");var e=arguments[2];j.marketUpdate[e]||(j.marketUpdate[e]=[]);for(var c=!0,d=0;d<j.marketUpdate[e].length;d++)j.marketUpdate[e][d]==b&&(c=!1);c&&j.marketUpdate[e].push(b);break;case"timestamp":for(var c=!0,d=0;d<j.timestamp.length;d++)j.timestamp[d]==b&&(c=!1);c&&j.timestamp.push(b)}},x=function(a){for(var b=0;b<a.length;b++){var e=a[b];"string"!=typeof a[b]&&(e=e.symbol),c[e]||(d.symbols.push(e),c[e]=!0)}},y=function(a){for(var b=0;b<a.length;b++)c[a[b]]&&(d.symbols_off.push(a[b]),c[a[b]]=!1)};return setTimeout(m,200),setTimeout(q,125),setTimeout(r,200),setTimeout(o,125),{connect:t,disconnect:u,getMarketState:function(){return h},getPassword:function(){return k.password},getProfileService:function(){return a},getUsername:function(){return k.username},off:v,on:w,requestSymbols:x,unRequestSymbols:y}},BarchartProfiles=function(){var a={},b=function(b){return a[b]},c=function(b,c){$.ajax({url:"proxies/instruments/?lookup="+b.join(",")}).done(function(b){if(200==b.status)for(var d=0;d<b.instruments.length;d++)a[b.instruments[d].lookup]=b.instruments[d];c()})};return{getProfile:b,getProfiles:c}},BarchartHistoricalData=function(){var a="proxies/historicaldata",b=function(b,c){$.ajax({url:a,dataType:"jsonp",data:b}).done(function(a){return c(a)})};return{getHistoricalData:b}};